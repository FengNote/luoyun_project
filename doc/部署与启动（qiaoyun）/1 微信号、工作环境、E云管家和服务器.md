# 微信号、工作环境、E云管家和服务器

## 微信号准备
- 请准备一个自己的副手机号，插入双卡手机（或者副手机）
- 用这个手机号注册一个微信号（以下称为托管微信），登录后，加一些好友随便聊几句
- 请在后续全程过程中，保证这个手机有电，以及托管微信处于登录状态

## E云管家
E云管家是目前luoyun框架使用的微信协议框架，特点是比较稳定，确定是需要付费（基础款￥200/月）。
市面上确实存在一些免费方案，但是它们不太稳定容易被封，所以我这里没有实现它们的对接。

### 相关链接
官网 https://wkteam.cn/
接入指南 https://wkteam.cn/jieruzhinan.html
API文档 https://wkteam.cn/api-wen-dang2/

### E云管家接入步骤
- 首先请注册E云管家。
- 进入用户中心 http://125.122.152.142:6327/#/dashboard ，进入【套餐】页购买一个套餐（可以先购买3天的测试套餐，验证是否能登录和发消息）
- 进入【微信管理】，在此处【登录新微信】，使用微信托管账号扫码登录。**注意：这里选择”地区“时，要选择你的微信登录的手机所在的地区，而不是你的服务器所在地区。**
    - 如果看到你的手机微信上出现”iPad微信已登录“，那么证明登录成功
- 刷新后，在这个页面可以得到托管微信号登录状态下的微信号，wId（登录态token），以及wcId（微信唯一id）。
    - 将wId填入config.json中的ecloud.wId.qiaoyun
    - 将微信号填入prepare_character.py当中的platforms.wechat.account
    - 将wcId填入prepare_character.py当中的platforms.wechat.id
- 进入【在线测试】【登录平台（第一步）】，在这里填入你的用户名和密码，然后登录一次，获取E云API的Authorization；将它填入config.json中的ecloud.Authorization。
- 接下来可以在【在线测试】当中测试一下是否能发送消息，以及了解一下具体的登录过程。

### 其他说明
- 在首次登录一天后，E云管家出于安全设定会掉线一次，此时需要执行【在线测试】登录中的前三步；登录成功后，需要将第二步中新生成的wId填入config.json中的ecloud.wId.qiaoyun，然后重启服务。
- 登录的第一天24小时内，无法发布朋友圈。

## 服务器
服务器方面我推荐用国内的阿里云ECS（由于模型服务基本都是国内的，建议使用国内的云计算厂商）。

### 阿里云ECS虚拟机创建
- 入口 https://ecs.console.aliyun.com/
- 在这里创建一个ECS实例，推荐的规格和配置如下：
    - 推荐使用：计算型 4vCPU + 8GB内存（2c4g我估计也能跑，但是会有点吃力）
    - 操作系统：Debian 12.10 x64
    - 存储：40GB
    - 需要开公网IP，按流量计费即可
    - 安全组：新建安全组，然后开80和443端口
    - 登录凭证：我喜欢 自定义密码 + ecs-user用户
- 之后你可以尝试登录一下 ssh ecs-user@xxx.xx.xx.xx，也可以把本机的ssh-key放过去
- 流量是要钱的，稍微充个10块钱的吧

## 配置E云消息回调地址
- 当托管微信bot收到消息时，E云管家会朝一个回调地址发送消息；我们会使用一个webserver（flask）来接收这个消息，这个服务地址需要配置到E云管家
- 在【在线测试】页（http://125.122.152.142:6327/#/onlineTest/index） ，找到消息接收-设置消息接收地址，在开发者回调地址(httpUrl)这里填入："http://xxx.xxx.xx.xx/message"，此处xxx.xxx.xx.xx是你上面申请的服务器公网ip。

## 工作环境
- 推荐使用vscode + remoteSSH插件